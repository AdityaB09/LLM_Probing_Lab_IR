{% extends "base.html" %}
{% block content %}
<section class="mb-6">
  <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-1">
        Insights AI
      </h1>
      <p class="text-slate-400 text-sm max-w-xl">
        Turn your probing history into an automated research report:
        cross-dataset trends, model winners, and layer signatures, all inferred
        from stored runs.
      </p>
    </div>
  </div>

  <form
    method="post"
    class="card flex flex-wrap gap-4 items-end border border-slate-800/80 mb-6"
  >
    <div class="min-w-[200px]">
      <label class="label">Focus metric</label>
      <select name="metric" class="input">
        <option value="accuracy" {% if metric=='accuracy' %}selected{% endif %}>
          Accuracy
        </option>
        <option value="f1" {% if metric=='f1' %}selected{% endif %}>
          Weighted F1
        </option>
        <option value="ece" {% if metric=='ece' %}selected{% endif %}>
          Calibration (ECE, lower is better)
        </option>
      </select>
      <p class="helper">
        What dimension should Insights AI optimize for?
      </p>
    </div>

    <div class="min-w-[200px]">
      <label class="label">Dataset filter</label>
      <select name="dataset" class="input">
        <option value="all" {% if dataset_filter=='all' %}selected{% endif %}>
          All datasets
        </option>
        {% for key, meta in datasets.items() %}
        <option
          value="{{ key }}"
          {% if dataset_filter==key %}selected{% endif %}
        >
          {{ meta.task_name }} ({{ key }})
        </option>
        {% endfor %}
      </select>
      <p class="helper">
        Restrict insights to one dataset or look across everything.
      </p>
    </div>

    <button type="submit" class="btn-primary">
      Generate Intelligence Report
    </button>
  </form>
</section>

{% if insights_summary %}
<section class="space-y-6">
  <div
    class="card border border-cyan-500/40 bg-gradient-to-br from-slate-950/80 via-slate-950/90 to-slate-900/90"
  >
    <h2 class="text-sm font-semibold text-cyan-300 mb-2">
      Narrative insight report
    </h2>
    <div class="prose prose-invert text-sm max-w-none leading-relaxed">
      {{ insights_summary | safe | replace('\n', '<br>') | safe }}
    </div>
  </div>

  {% if insights_data %}
  <div class="grid lg:grid-cols-2 gap-6">
    <div class="panel">
      <h3 class="panel-title">Best {{ metric }} per model/dataset</h3>
      <canvas id="insightsModelChart"></canvas>
    </div>
    <div class="panel">
      <h3 class="panel-title">Layer signature (mean {{ metric }})</h3>
      <canvas id="insightsLayerChart"></canvas>
    </div>
  </div>

  <script>
    const insightsData = {{ insights_data | tojson }};
    window.addEventListener("load", () => {
      renderInsightsCharts(insightsData);
    });
  </script>
  {% endif %}
</section>
{% else %}
<p class="text-slate-400 text-sm">
  No insights yet â€” run a few experiments first so we have something to
  analyze.
</p>
{% endif %}
{% endblock %}
