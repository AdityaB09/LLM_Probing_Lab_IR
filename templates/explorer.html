{% extends "base.html" %}
{% block content %}
<section class="mb-6">
  <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-1">
        Dataset Explorer
      </h1>
      <p class="text-slate-400 text-sm max-w-xl">
        Inspect the underlying data before probing: label balance, sample
        counts, and example rows with real text.
      </p>
    </div>
  </div>

  <form
    method="post"
    class="card flex flex-wrap gap-4 items-end dataset-form"
  >
    <div class="flex-1 min-w-[220px]">
      <label class="label">Dataset</label>
      <select name="dataset" class="input">
        {% for key, meta in datasets.items() %}
        <option value="{{ key }}" {% if key == dataset_key %}selected{% endif %}>
          {{ meta.task_name }} ({{ key }})
        </option>
        {% endfor %}
      </select>
      <p class="helper">
        These map directly to Kaggle datasets configured in
        <code>config.py</code>.
      </p>
    </div>

    <div class="w-full sm:w-40">
      <label class="label">Max samples</label>
      <input
        type="number"
        min="100"
        max="{{ config.MAX_SAMPLES_HARD_LIMIT }}"
        name="max_samples"
        value="{{ max_samples }}"
        class="input"
      />
      <p class="helper">Cap data for fast exploratory runs.</p>
    </div>

    <button type="submit" class="btn-primary">
      Refresh Explorer
    </button>
  </form>
</section>

<section class="grid lg:grid-cols-3 gap-5 mb-8">
  <div class="stat-card">
    <p class="stat-label">Task</p>
    <p class="stat-value text-lg">{{ info.task_name }}</p>
    <p class="stat-sub">
      Key: <span class="font-mono text-xs">{{ dataset_key }}</span>
    </p>
  </div>

  <div class="stat-card">
    <p class="stat-label">Samples loaded</p>
    <p class="stat-value">{{ info.num_samples }}</p>
    <p class="stat-sub">Bounded by your max-sample setting.</p>
  </div>

  <div class="stat-card">
    <p class="stat-label">Classes</p>
    <p class="stat-value">{{ info.num_classes }}</p>
    <p class="stat-sub">
      {% for label, cnt in info.class_counts.items() %}
      <span class="pill">{{ label }}: {{ cnt }}</span>
      {% endfor %}
    </p>
  </div>
</section>

<section class="grid lg:grid-cols-2 gap-6 mb-10">
  <div class="panel">
    <h2 class="panel-title">Label Distribution</h2>
    <p class="text-xs text-slate-400 mb-2">
      Quick visual check that the dataset isnâ€™t wildly skewed.
    </p>
    <canvas id="classChart" height="180"></canvas>
  </div>

  <div class="panel">
    <h2 class="panel-title">Sample rows</h2>
    <p class="text-xs text-slate-400 mb-2">
      Real text snippets with their labels, directly pulled from the dataset
      after shuffling.
    </p>
    <div class="space-y-3 max-h-[260px] overflow-auto pr-1">
      {% for text, label in preview %}
      <div class="sample-card">
        <div class="flex justify-between text-[11px] mb-1">
          <span class="pill pill-soft">Label: {{ label }}</span>
        </div>
        <p class="text-sm text-slate-100 leading-snug">{{ text }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
  // Build class distribution chart
  const classLabels = {{ info.class_counts.keys()|list|tojson }};
  const classValues = {{ info.class_counts.values()|list|tojson }};

  const ctxCls = document.getElementById("classChart");
  if (ctxCls) {
    new Chart(ctxCls, {
      type: "bar",
      data: {
        labels: classLabels,
        datasets: [
          {
            label: "Count",
            data: classValues,
            backgroundColor: ["#22d3ee66", "#a855f766", "#f9731666", "#22c55e66"],
            borderColor: ["#22d3ee", "#a855f7", "#f97316", "#22c55e"],
            borderWidth: 1.5,
          },
        ],
      },
      options: {
        plugins: {
          legend: { display: false },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", font: { size: 11 } },
          },
          y: {
            ticks: { color: "#9ca3af", font: { size: 11 } },
          },
        },
      },
    });
  }
</script>
{% endblock %}
