{% extends "base.html" %}
{% block content %}
<section class="mb-6">
  <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-1">
        Compare Models (Instant)
      </h1>
      <p class="text-slate-400 text-sm max-w-xl">
        Spin up a fresh comparison: same dataset & sample size, two encoders.
        We’ll probe every layer and overlay their curves for accuracy, F1, and
        calibration.
      </p>
    </div>
  </div>

  <form
    method="post"
    id="compare-form"
    class="card space-y-4 border border-slate-800/80"
  >
    <div class="grid md:grid-cols-4 gap-4">
      <div>
        <label class="label">Dataset</label>
        <select name="dataset" class="input">
          {% for key, meta in datasets.items() %}
          <option value="{{ key }}">{{ meta.task_name }} ({{ key }})</option>
          {% endfor %}
        </select>
        <p class="helper">Backed by Kaggle datasets in config.py.</p>
      </div>

      <div>
        <label class="label">Max samples</label>
        <input
          type="number"
          name="max_samples"
          value="{{ config.DEFAULT_MAX_SAMPLES }}"
          min="200"
          max="{{ config.MAX_SAMPLES_HARD_LIMIT }}"
          class="input"
        />
        <p class="helper">Higher = more stable but slower.</p>
      </div>

      <div>
        <label class="label">Model A</label>
        <select name="model_a" class="input">
          {% for m in models %}
          <option value="{{ m }}">{{ m }}</option>
          {% endfor %}
        </select>
        <p class="helper">Left curve in the chart.</p>
      </div>

      <div>
        <label class="label">Model B</label>
        <select name="model_b" class="input">
          {% for m in models %}
          <option value="{{ m }}" {% if loop.index == 2 %}selected{% endif %}>
            {{ m }}
          </option>
          {% endfor %}
        </select>
        <p class="helper">Right curve in the chart.</p>
      </div>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-3 pt-2">
      <button type="submit" class="btn-primary">
        Launch Comparison Experiment
      </button>

      <div class="flex flex-wrap gap-2 text-[11px] text-slate-400">
        <span class="pill pill-soft">
          Live probes (not from history)
        </span>
        <span class="pill pill-soft">
          Same dataset, two encoders
        </span>
      </div>
    </div>
  </form>
</section>

{% if result %}
<section class="space-y-6">
  <div
    class="card border border-cyan-500/40 bg-gradient-to-br from-slate-950/80 via-slate-950/90 to-slate-900/90"
  >
    <div class="flex flex-wrap items-center justify-between gap-3 mb-2">
      <div>
        <h2 class="text-lg font-semibold text-cyan-300">
          {{ result.task_name }} ({{ result.dataset_key }})
        </h2>
        <p class="text-xs text-slate-400">
          {{ result.sample_size }} samples · {{ result.model_a }} vs
          {{ result.model_b }}
        </p>
      </div>
      <div class="flex gap-2 text-[11px] text-slate-300">
        <span class="pill">
          <span class="dot dot-cyan"></span>{{ result.model_a }}
        </span>
        <span class="pill">
          <span class="dot dot-fuchsia"></span>{{ result.model_b }}
        </span>
      </div>
    </div>

    <div class="prose prose-invert text-sm max-w-none leading-relaxed">
      {{ result.summary | safe | replace('\n', '<br>') | safe }}
    </div>
  </div>

  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-2 text-[11px] text-slate-400">
      <span class="dot dot-cyan"></span>{{ result.model_a }}
      <span class="dot dot-fuchsia ml-3"></span>{{ result.model_b }}
    </div>
    <div class="flex gap-2 text-[11px]">
      <button
        type="button"
        class="metric-chip metric-chip-active"
        data-metric="acc"
      >
        Accuracy
      </button>
      <button type="button" class="metric-chip" data-metric="f1">
        Weighted F1
      </button>
      <button type="button" class="metric-chip" data-metric="ece">
        Calibration (ECE)
      </button>
    </div>
  </div>

  <div class="panel">
    <h3 class="panel-title">
      Metric vs Layer · {{ result.model_a }} vs {{ result.model_b }}
    </h3>
    <canvas id="compareMetricChart"></canvas>
  </div>
</section>

<script>
  const cmpResult = {{ result|tojson }};
  window.addEventListener("load", () => {
    renderInlineCompareCharts(
      cmpResult.metrics_a,
      cmpResult.metrics_b,
      cmpResult.model_a,
      cmpResult.model_b
    );
  });
</script>
{% endif %}
{% endblock %}
